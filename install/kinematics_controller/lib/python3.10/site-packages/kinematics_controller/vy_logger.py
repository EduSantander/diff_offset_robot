#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
import matplotlib.pyplot as plt
from geometry_msgs.msg import Twist
from nav_msgs.msg import Odometry
from sensor_msgs.msg import JointState

class VyValidationLogger(Node):
    def __init__(self):
        super().__init__('vy_validation_logger')
        
        # -----------------------
        # TUS PARÁMETROS EXACTOS (Extraídos de tu código)
        # -----------------------
        self.R = 0.055       # Radio de rueda
        self.d1 = 0.11225    # Distancia Offset
        self.d2 = 0.36       # Distancia entre ruedas (Track Width)
        
        self.start_time = self.get_clock().now().nanoseconds
        
        # Estado
        self.wl = 0.0 
        self.wr = 0.0 
        self.current_ref_vy = 0.0
        
        # Datos para graficar
        self.t_data = []
        self.ref_vy = []    # Deseada (Input)
        self.odom_vy = []   # Odometría (Tu Nodo)
        self.calc_vy = []   # Calculada Manual (Joint States)
        
        # Debug
        self.names_detected = False

        # Suscriptores
        self.create_subscription(Twist, '/cmd_vel', self.cmd_cb, 10)
        self.create_subscription(Odometry, '/odom', self.odom_cb, 10)
        self.create_subscription(JointState, '/joint_states', self.joint_cb, 10)

        self.get_logger().info(f"--- LOGGER Vy CALIBRADO ---")
        self.get_logger().info(f"Params: R={self.R}, d1={self.d1}, d2={self.d2}")
        self.get_logger().info("Mueve el robot. Si la linea verde sigue en 0, revisa el URDF.")

    def get_time(self):
        return (self.get_clock().now().nanoseconds - self.start_time) / 1e9

    def cmd_cb(self, msg):
        self.current_ref_vy = msg.linear.y

    def joint_cb(self, msg):
        # Filtro de seguridad: Ignorar mensajes sin velocidad
        if len(msg.velocity) == 0:
            return

        # Debug: Imprimir nombres una sola vez para verificar
        if not self.names_detected:
            self.get_logger().info(f"Joints encontrados: {msg.name}")
            self.names_detected = True

        try:
            # Buscamos 'left' y 'wheel' en el nombre para ser robustos ante prefijos
            for i, name in enumerate(msg.name):
                if 'left' in name and 'wheel' in name:
                    self.wl = msg.velocity[i]
                if 'right' in name and 'wheel' in name:
                    self.wr = msg.velocity[i]
        except ValueError:
            pass

    def odom_cb(self, msg):
        t = self.get_time()
        self.t_data.append(t)
        
        # 1. Referencia
        self.ref_vy.append(self.current_ref_vy)
        
        # 2. Tu Odometría
        self.odom_vy.append(msg.twist.twist.linear.y)
        
        # 3. Cálculo Manual usando TU fórmula cinemática
        # Vy = (R * d1 / d2) * (wr - wl)
        # Nota: En tu código a21 y a22 tenían signos opuestos para la fila 2.
        # Vy = a21*alphaL + a22*alphaR
        # Con theta=0: a21 = -R*d1/d2, a22 = +R*d1/d2
        # Vy = (R*d1/d2) * (alphaR - alphaL)
        
        term = (self.R * self.d1) / self.d2
        vy_manual = term * (self.wr - self.wl)
        
        self.calc_vy.append(vy_manual)

    def plot_results(self):
        if not self.t_data:
            print("No se recibieron datos.")
            return

        print(f"\nÚltimos valores -> WL: {self.wl:.3f}, WR: {self.wr:.3f}, Vy Calc: {self.calc_vy[-1]:.3f}")
        
        plt.figure(figsize=(10, 6))
        plt.title(f"VALIDACIÓN Vy (R={self.R}, d1={self.d1})")
        
        # Referencia (Negro Punteado)
        plt.plot(self.t_data, self.ref_vy, 'k--', linewidth=1.5, label='Vy Deseada')
        
        # Tu Nodo (Rojo Sólido)
        plt.plot(self.t_data, self.odom_vy, 'r-', linewidth=3, alpha=0.6, label='Vy Odometría')
        
        # Cálculo Manual (Verde Punteado)
        plt.plot(self.t_data, self.calc_vy, 'g:', linewidth=2, label='Vy Calculada (Joints)')
        
        plt.xlabel("Tiempo [s]")
        plt.ylabel("Velocidad [m/s]")
        plt.legend()
        plt.grid(True)
        plt.show()

def main(args=None):
    rclpy.init(args=args)
    logger = VyValidationLogger()
    try:
        rclpy.spin(logger)
    except KeyboardInterrupt:
        pass
    finally:
        logger.plot_results()
        logger.destroy_node()
        rclpy.shutdown()

if __name__ == '__main__':
    main()